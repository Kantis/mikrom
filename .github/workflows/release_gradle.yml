name: Release

on:
   push:
      tags:
         - 'v[0-9]+.[0-9]+.[0-9]+'

jobs:
   release:
      runs-on: ubuntu-latest
      permissions:
         contents: write

      steps:
         - uses: actions/checkout@v5

         - name: Extract version from tag
           id: extract_version
           run: |
              VERSION=${GITHUB_REF#refs/tags/v}
              echo "version=${VERSION}" >> $GITHUB_OUTPUT
              echo "Extracted version: ${VERSION}"

         - name: Set up JDK 21
           uses: actions/setup-java@v5
           with:
              java-version: '21'
              distribution: 'temurin'

         - name: Setup Gradle
           uses: gradle/actions/setup-gradle@v4

         - name: Run tests
           run: ./gradlew test -Pversion=${{ steps.extract_version.outputs.version }}

         - name: Build
           run: ./gradlew build -Pversion=${{ steps.extract_version.outputs.version }}

         - name: Publish to Maven Central
           env:
              GRADLE_PUBLISH_KEY: ${{ secrets.GRADLE_PUBLISH_KEY }}
              GRADLE_PUBLISH_SECRET: ${{ secrets.GRADLE_PUBLISH_SECRET }}
           run: ./gradlew publishPlugins -Pversion=${{ steps.extract_version.outputs.version }}
